import streamlit as st
import matplotlib.pyplot as plt
import numpy as np
import pandas as pd
from utils import leitor_de_texto, get_anon_user_id, log_acesso_google, log_interacao_google, safe_log_interacao

def main():
    st.title("üìà Custeio Vari√°vel (Gerencial) ‚Äì Aprendizado Interativo")
    # Recupera o nome do usu√°rio
    nome_usuario = get_anon_user_id()
    pagina_atual = "Custeio Variavel"
    
    # Registra o acesso
    if 'page4_acessada' not in st.session_state:
        log_acesso_google(nome_usuario, pagina_atual, f"acessou_{pagina_atual}")
        st.session_state.page4_acessada = True

    st.markdown("""
    Bem-vindo √† an√°lise interativa do **Custeio Vari√°vel**!  
    Aqui voc√™ vai entender como esse m√©todo auxilia na **tomada de decis√µes gerenciais**, com simula√ß√µes, exerc√≠cios e compara√ß√µes pr√°ticas.
    """)

    # ===========================
    # Expander 1: M√©todo de Custeio Gerencial
    # ===========================
    with st.expander("üîç 1. M√©todo de Custeio Gerencial", expanded=False):
        st.markdown("""
        ### üí° O que √© Custeio Vari√°vel?
        Tamb√©m chamado de **custeio direto** ou **custeio marginal**, ele separa custos fixos e vari√°veis, tratando os **custos fixos como despesa do per√≠odo** (n√£o s√£o alocados aos produtos).

        ‚úÖ **Vantagens:**
        - Facilita an√°lise de margem de contribui√ß√£o
        - Melhor para decis√µes de curto prazo
        - Evita distor√ß√µes no lucro com varia√ß√µes de estoque

        ‚ùå **Custeio por Absor√ß√£o:**
        - Aloca custos fixos aos produtos
        - Pode inflar o lucro se estoques aumentarem
        """)

        st.subheader("üìå Atividade: Identifique o M√©todo Correto")
        resposta1 = st.radio(
            "Em qual m√©todo o lucro pode aumentar mesmo sem venda, apenas com aumento de produ√ß√£o e estoque?",
            options=["Custeio Vari√°vel", "Custeio por Absor√ß√£o"],
            key="q1"
        )
        if st.button("‚úÖ Verificar Resposta", key="b1"):
            if resposta1 == "Custeio por Absor√ß√£o":
                st.success("Correto! O custeio por absor√ß√£o aloca custos fixos aos produtos, ent√£o aumentar estoque 'empurra' custos para o futuro, inflando o lucro.")
            else:
                st.error("Incorreto. Reveja: no custeio vari√°vel, custos fixos s√£o despesas imediatas, ent√£o n√£o h√° esse efeito.")

    # ===========================
    # Expander 2: Margem de Contribui√ß√£o
    # ===========================
    with st.expander("üìä 2. Margem de Contribui√ß√£o", expanded=False):
        st.markdown("""
        ### üìà O que √© Margem de Contribui√ß√£o (MC)?
        - **MC = Pre√ßo de Venda - Custo Vari√°vel Unit√°rio**
        - Representa o quanto cada unidade vendida contribui para cobrir custos fixos e gerar lucro.

        **MC Total = MC unit√°ria √ó quantidade**
        """)

        st.subheader("üßÆ Calcule a Margem de Contribui√ß√£o")
        preco_venda = st.number_input("Pre√ßo de Venda Unit√°rio (R$)", min_value=0.0, value=100.0, step=1.0, key="mc_pv")
        custo_var = st.number_input("Custo Vari√°vel Unit√°rio (R$)", min_value=0.0, value=60.0, step=1.0, key="mc_cv")
        qtd_vendida = st.number_input("Quantidade Vendida", min_value=0, value=500, step=10, key="mc_qtd")

        if preco_venda > 0:
            mc_unit = preco_venda - custo_var
            mc_total = mc_unit * qtd_vendida
            st.metric("Margem de Contribui√ß√£o Unit√°ria", f"R$ {mc_unit:.2f}")
            st.metric("Margem de Contribui√ß√£o Total", f"R$ {mc_total:.2f}")

            st.progress(mc_unit / preco_venda if preco_venda > 0 else 0)
            st.caption(f"{(mc_unit / preco_venda * 100):.1f}% do pre√ßo vai para cobrir CF e lucro.")

    # ===========================
    # Expander 3: Elabora√ß√£o de DRE com Custeio Gerencial
    # ===========================
    with st.expander("üìë 3. Elabora√ß√£o de DRE com Custeio Gerencial", expanded=False):
        st.markdown("""
        ### üßæ Demonstra√ß√£o de Resultados com Custeio Vari√°vel
        Compare com o custeio por absor√ß√£o:
        """)

        receita = st.number_input("Receita Total (R$)", 50000, 200000, 100000, key="dre_receita")
        cv_total = st.number_input("Custos Vari√°veis Totais (R$)", 10000, 80000, 50000, key="dre_cv")
        cf_total = st.number_input("Custos Fixos Totais (R$)", 10000, 60000, 30000, key="dre_cf")

        mc = receita - cv_total
        lucro = mc - cf_total

        dre_df = pd.DataFrame({
            "Descri√ß√£o": [
                "Receita",
                "(-) Custos Vari√°veis",
                "Margem de Contribui√ß√£o",
                "(-) Custos Fixos",
                "Lucro Operacional"
            ],
            "Valor (R$)": [
                f"R$ {receita:,.2f}",
                f"-- R$ {cv_total:,.2f}",
                f"R$ {mc:,.2f}",
                f"-- R$ {cf_total:,.2f}",
                f"R$ {lucro:,.2f}"
            ]
        })

        st.table(dre_df)

        if lucro > 0:
            st.success("‚úÖ Empresa lucrativa!")
        elif lucro == 0:
            st.info("üü° Ponto de equil√≠brio atingido.")
        else:
            st.warning("‚ö†Ô∏è Preju√≠zo operacional.")

    # ===========================
    # Expander 4: An√°lise CVL e Ponto de Equil√≠brio
    # ===========================
    with st.expander("üìâ 4. An√°lise Custo-Volume-Lucro e Ponto de Equil√≠brio", expanded=False):
        st.markdown("### üéØ Ponto de Equil√≠brio (Break-Even Point)")

        preco_pe = st.number_input("Pre√ßo Unit√°rio (R$)", 10.0, 200.0, 50.0, key="pe_pv")
        cvu_pe = st.number_input("Custo Vari√°vel Unit√°rio (R$)", 1.0, 150.0, 30.0, key="pe_cvu")
        cf_pe = st.number_input("Custos Fixos Totais (R$)", 1000, 50000, 20000, key="pe_cf")

        if preco_pe > cvu_pe:
            mc_pe = preco_pe - cvu_pe
            pe_qtde = cf_pe / mc_pe
            pe_receita = pe_qtde * preco_pe

            st.metric("Ponto de Equil√≠brio (quantidade)", f"{pe_qtde:.0f} unidades")
            st.metric("Ponto de Equil√≠brio (em receita)", f"R$ {pe_receita:,.2f}")

            # Gr√°fico de CVL
            q_range = np.linspace(0, pe_qtde * 2, 200)
            rt = preco_pe * q_range
            ct = cf_pe + cvu_pe * q_range
            lucro_linha = rt - ct

            fig, ax = plt.subplots(figsize=(8, 5))
            ax.plot(q_range, rt, label="Receita Total", color="green")
            ax.plot(q_range, ct, label="Custo Total", color="red")
            ax.plot(q_range, lucro_linha, label="Lucro", color="blue", linestyle="--")
            ax.axvline(x=pe_qtde, color="purple", linestyle=":", label="Ponto de Equil√≠brio")
            ax.axhline(y=0, color="black", linewidth=0.8)
            ax.set_xlabel("Quantidade")
            ax.set_ylabel("R$")
            ax.legend()
            ax.grid(alpha=0.3)
            st.pyplot(fig)
        else:
            st.error("‚ö†Ô∏è O custo vari√°vel n√£o pode ser maior ou igual ao pre√ßo de venda.")

    # ===========================
    # Expander 5: Margem de Seguran√ßa e Alavancagem
    # ===========================
    with st.expander("üõ°Ô∏è 5. Margem de Seguran√ßa e Alavancagem Operacional", expanded=False):
        qtde_vendida = st.number_input("Quantidade Vendida Atual", min_value=1, value=1000, key="ms_qtde")
        pe_calc = cf_pe / (preco_pe - cvu_pe) if (preco_pe - cvu_pe) > 0 else 0

        if qtde_vendida > pe_calc:
            ms_percent = ((qtde_vendida - pe_calc) / qtde_vendida) * 100
            st.metric("Margem de Seguran√ßa", f"{ms_percent:.1f}%")
            st.progress(ms_percent / 100)
            st.info(f"A empresa pode reduzir as vendas em {ms_percent:.1f}% antes de entrar no preju√≠zo.")
        else:
            st.warning("‚ö†Ô∏è As vendas est√£o abaixo do ponto de equil√≠brio.")

        # Alavancagem Operacional
        if mc > 0:
            alavancagem = mc / (mc - cf_total) if (mc - cf_total) != 0 else float('inf')
            if alavancagem > 0:
                st.metric("Alavancagem Operacional", f"{alavancagem:.2f}x")
                st.markdown(f"""
                - **Significado:** Um aumento de 1% nas vendas gera um aumento de **{alavancagem:.2f}% no lucro**.
                - Alta alavancagem = maior risco, mas maior retorno potencial.
                """)

    # ===========================
    # Expander 6: Tomada de Decis√£o
    # ===========================
    with st.expander("‚úÖ 6. Tomada de Decis√£o com Custeio Gerencial", expanded=False):
        st.markdown(r"""
        ### üß© Exemplo: Aceitar um pedido especial?
        Um cliente oferece comprar 200 unidades a R\$ 45,00 cada.  
        Custo vari√°vel unit√°rio: R\$ 30,00. Custo fixo n√£o aumenta.  
        Capacidade ociosa dispon√≠vel.
        """)

        decisao = st.radio(
            "Voc√™ aceitaria o pedido?",
            options=["Sim", "N√£o", "Depende"],
            key="decisao_pedido"
        )

        if st.button("üí° Mostrar An√°lise", key="analise_decisao"):
            receita_adicional = 200 * 45
            custo_adicional = 200 * 30
            mc_adicional = receita_adicional - custo_adicional

            st.write(f"- Receita adicional: R$ {receita_adicional:,.2f}")
            st.write(f"- Custo vari√°vel adicional: R$ {custo_adicional:,.2f}")
            st.write(f"- **Margem de Contribui√ß√£o adicional: R$ {mc_adicional:,.2f}**")

            if decisao == "Sim":
                st.success("Correto! Como h√° capacidade ociosa e o pre√ßo > CVU, o pedido aumenta o lucro.")
            else:
                st.info("Reavalie: mesmo com pre√ßo baixo, se cobre o custo vari√°vel e n√£o h√° custo fixo adicional, vale a pena.")

    # ===========================
    # Expander 7: Defici√™ncias do Custeio por Absor√ß√£o
    # ===========================
    with st.expander("‚ö†Ô∏è 7. Defici√™ncias do Custeio por Absor√ß√£o", expanded=False):
        st.markdown(r"""
        ### ‚ùå Por que o custeio por absor√ß√£o pode atrapalhar decis√µes?
        - **Efeito do estoque:** lucro sobe com produ√ß√£o (mesmo sem venda)
        - **M√°scara de rentabilidade:** produtos com alto custo fixo podem parecer menos lucrativos
        - **Decis√µes erradas:** pode levar √† manuten√ß√£o de produtos n√£o vi√°veis

        üìå **Exemplo:**
        - Produ√ß√£o: 10.000 unidades, Vendas: 8.000 unidades
        - Custo fixo: R\$ 100.000 ‚Üí R$ 10/unidade alocado
        - Lucro cont√°bil: positivo (porque R\$ 20.000 de custo fixo est√£o no estoque)
        - Mas caixa n√£o entrou!
        """)

        st.info("üí° O custeio vari√°vel mostra o fluxo real de contribui√ß√£o, melhor para decis√µes de curto prazo.")

    # ===========================
    # Expander 8: Testes Interativos
    # ===========================
    with st.expander("üìù Teste seus Conhecimentos - N√≠vel Intermedi√°rio", expanded=False):
        st.markdown("### üß† Avalie seu entendimento sobre custeio vari√°vel e an√°lise gerencial:")
    
        questions = [
            {
                "question": "No custeio vari√°vel, como s√£o tratados os custos fixos de fabrica√ß√£o?",
                "options": [
                    "Alocados aos produtos com base em horas m√°quina",
                    "Distribu√≠dos entre os produtos vendidos",
                    "Tratados como despesa do per√≠odo",
                    "Inclu√≠dos no custo dos estoques",
                    "Rateados entre departamentos"
                ],
                "correct": 2,
                "explanation": "No custeio vari√°vel, os custos fixos de fabrica√ß√£o **n√£o s√£o alocados aos produtos**, s√£o tratados como despesas do per√≠odo."
            },
            {
                "question": "O que representa a Margem de Contribui√ß√£o (MC)?",
                "options": [
                    "Lucro l√≠quido por unidade",
                    "Receita menos custos fixos",
                    "Receita menos custos vari√°veis",
                    "Custo vari√°vel total",
                    "Despesas operacionais"
                ],
                "correct": 2,
                "explanation": "MC = Receita - Custos Vari√°veis. Representa o valor dispon√≠vel para cobrir custos fixos e gerar lucro."
            },
            {
                "question": "Qual √© a principal vantagem do custeio vari√°vel em rela√ß√£o ao custeio por absor√ß√£o?",
                "options": [
                    "Maior conformidade com a legisla√ß√£o fiscal",
                    "Melhor adequa√ß√£o √†s normas cont√°beis",
                    "Facilita decis√µes de curto prazo e an√°lise CVL",
                    "Aumenta o lucro cont√°bil",
                    "Reduz o imposto de renda"
                ],
                "correct": 2,
                "explanation": "O custeio vari√°vel √© mais √∫til para **decis√µes gerenciais**, pois separa custos fixos e vari√°veis, facilitando an√°lises de contribui√ß√£o e ponto de equil√≠brio."
            },
            {
                "question": "Em uma DRE com custeio vari√°vel, qual item aparece antes dos custos fixos?",
                "options": [
                    "Lucro operacional",
                    "Receita bruta",
                    "Custos fixos administrativos",
                    "Margem de Contribui√ß√£o",
                    "Custo dos produtos vendidos"
                ],
                "correct": 3,
                "explanation": "A estrutura √©: Receita ‚Üí (-) Custos Vari√°veis ‚Üí **Margem de Contribui√ß√£o** ‚Üí (-) Custos Fixos ‚Üí Lucro."
            },
            {
                "question": "O que acontece com o lucro no custeio por absor√ß√£o quando a produ√ß√£o excede as vendas?",
                "options": [
                    "Diminui, pois h√° mais custos",
                    "Permanece constante",
                    "Aumenta, pois parte dos custos fixos vai para o estoque",
                    "Torna-se negativo",
                    "Depende do custo vari√°vel"
                ],
                "correct": 2,
                "explanation": "No custeio por absor√ß√£o, custos fixos s√£o alocados aos produtos. Se houver estoque, parte dos custos fixos √© **adiada para o futuro**, aumentando o lucro cont√°bil do per√≠odo."
            },
            {
                "question": "Como √© calculado o ponto de equil√≠brio em unidades?",
                "options": [
                    "Custos Fixos / Pre√ßo de Venda",
                    "Custos Vari√°veis / Margem de Contribui√ß√£o Unit√°ria",
                    "Custos Fixos / Margem de Contribui√ß√£o Unit√°ria",
                    "Receita / Custos Totais",
                    "Lucro / Custo Vari√°vel Unit√°rio"
                ],
                "correct": 2,
                "explanation": "Ponto de equil√≠brio (unidades) = CF / (PV - CVU) = CF / MC unit√°ria."
            },
            {
                "question": "Se o pre√ßo de venda √© R\\$ 80, o custo vari√°vel √© R\\$ 50 e os custos fixos s√£o R\\$ 30.000, qual √© o ponto de equil√≠brio?",
                "options": [
                    "600 unidades",
                    "750 unidades",
                    "1.000 unidades",
                    "1.200 unidades",
                    "1.500 unidades"
                ],
                "correct": 2,  # 30000 / (80-50) = 1000
                "explanation": "MC unit√°ria = R\\$ 30. PE = 30.000 / 30 = **1.000 unidades**."
            },
            {
                "question": "Qual √© a f√≥rmula da margem de seguran√ßa?",
                "options": [
                    "(Vendas reais - Vendas planejadas) / Vendas reais",
                    "(Vendas atuais - Ponto de equil√≠brio) / Vendas atuais",
                    "Vendas atuais / Ponto de equil√≠brio",
                    "Ponto de equil√≠brio / Vendas atuais",
                    "Lucro / Custos Fixos"
                ],
                "correct": 1,
                "explanation": "Margem de seguran√ßa = (Vendas atuais - Vendas no PE) / Vendas atuais. Mostra quanto as vendas podem cair sem preju√≠zo."
            },
            {
                "question": "Um produto tem MC de R\\$ 40.000 e lucro de R\\$ 10.000. Qual √© a alavancagem operacional?",
                "options": [
                    "2x",
                    "3x",
                    "4x",
                    "5x",
                    "6x"
                ],
                "correct": 2,  # 40.000 / 10.000 = 4
                "explanation": "Alavancagem = MC / Lucro = 40.000 / 10.000 = **4x**. Um aumento de 1% nas vendas gera 4% de aumento no lucro."
            },
            {
                "question": "Por que o custeio por absor√ß√£o pode levar a decis√µes erradas?",
                "options": [
                    "Porque n√£o considera custos vari√°veis",
                    "Porque subestima o custo dos produtos",
                    "Porque pode incentivar superprodu√ß√£o para inflar o lucro",
                    "Porque √© mais caro de implementar",
                    "Porque n√£o √© aceito pela Receita Federal"
                ],
                "correct": 2,
                "explanation": "Ao alocar custos fixos aos produtos, o custeio por absor√ß√£o pode **inflar o lucro com aumento de estoque**, levando a decis√µes de produ√ß√£o inadequadas."
            }
        ]
    
        if 'quiz_answers_part1' not in st.session_state:
            st.session_state.quiz_answers_part1 = [None] * len(questions)
    
        user_score = 0
        for i, q in enumerate(questions):
            st.markdown(f"**{i+1}. {q['question']}**")
            user_answer = st.radio(
                q["question"],
                options=q["options"],
                key=f"quiz1_q{i}",
                index=st.session_state.quiz_answers_part1[i] if st.session_state.quiz_answers_part1[i] is not None else None
            )
            st.session_state.quiz_answers_part1[i] = q["options"].index(user_answer) if user_answer else None
    
            if user_answer:
                if q["options"].index(user_answer) == q["correct"]:
                    st.success("‚úÖ Correto!")
                    user_score += 1
                else:
                    st.error(f"‚ùå Incorreto. A resposta correta √©: **{q['options'][q['correct']]}**.")
                    with st.expander("üìò Explica√ß√£o"):
                        st.markdown(q["explanation"])
    
        if all(ans is not None for ans in st.session_state.quiz_answers_part1):
            st.markdown("---")
            st.markdown(f"### üéØ Pontua√ß√£o: **{user_score}/{len(questions)}**")
            if user_score >= 9:
                st.balloons()
                st.success("üéâ Excelente! Voc√™ domina os conceitos de custeio gerencial!")
            elif user_score >= 6:
                st.success("üëç Bom desempenho!")
            else:
                st.warning("üìö Revise os t√≥picos. Os expanders anteriores podem ajudar.")
    
    # ===========================
    # Expander 9: Testes Interativos ‚Äì Parte 2 (avan√ßado)
    # ===========================
    with st.expander("üß† Testes Avan√ßados (Aplica√ß√£o e Decis√£o)", expanded=False):
        st.markdown("### üîç Aprofunde seu conhecimento com quest√µes de aplica√ß√£o pr√°tica:")
    
        questions = [
            {
                "question": "Uma empresa tem MC de R\$ 100.000 e custos fixos de R\\$ 70.000. Qual √© o lucro operacional?",
                "options": [
                    "R\\$ 170.000",
                    "R\\$ 100.000",
                    "R\\$ 70.000",
                    "R\\$ 30.000",
                    "R\\$ 0"
                ],
                "correct": 3,  # 100k - 70k = 30k
                "explanation": "Lucro = MC - CF = 100.000 - 70.000 = R\\$ 30.000."
            },
            {
                "question": "Se a margem de seguran√ßa √© 25% e as vendas atuais s√£o 8.000 unidades, qual √© o ponto de equil√≠brio?",
                "options": [
                    "2.000 unidades",
                    "4.000 unidades",
                    "6.000 unidades",
                    "7.000 unidades",
                    "8.000 unidades"
                ],
                "correct": 2,  # 8000 - (0.25*8000) = 6000
                "explanation": "MS = 25% ‚Üí PE = 75% das vendas ‚Üí 0.75 √ó 8.000 = **6.000 unidades**."
            },
            {
                "question": "Um produto tem alavancagem operacional de 5x. Se as vendas aumentarem 10%, quanto aumentar√° o lucro?",
                "options": [
                    "10%",
                    "20%",
                    "30%",
                    "40%",
                    "50%"
                ],
                "correct": 4,  # 5 √ó 10% = 50%
                "explanation": "Alavancagem de 5x significa que o lucro varia 5 vezes mais que as vendas: 5 √ó 10% = **50%**."
            },
            {
                "question": "Em qual situa√ß√£o o custeio vari√°vel √© mais apropriado?",
                "options": [
                    "Para apura√ß√£o de imposto de renda",
                    "Para demonstra√ß√µes financeiras externas",
                    "Para an√°lise de mix de produtos e decis√µes de curto prazo",
                    "Para controle de estoque em armaz√©m",
                    "Para auditoria fiscal"
                ],
                "correct": 2,
                "explanation": "O custeio vari√°vel √© ideal para **decis√µes internas**, como an√°lise de mix, pre√ßo m√≠nimo, aceita√ß√£o de pedidos especiais, etc."
            },
            {
                "question": "Um pedido especial oferece vender 1.000 unidades a R\\$ 25. O custo vari√°vel √© R\\$ 20. Custos fixos n√£o aumentam. Voc√™ aceita?",
                "options": [
                    "N√£o, porque √© abaixo do pre√ßo normal",
                    "N√£o, porque reduz a margem",
                    "Sim, se houver capacidade ociosa",
                    "Sim, mesmo com capacidade cheia",
                    "Depende do custo fixo"
                ],
                "correct": 2,
                "explanation": "Se h√° capacidade ociosa, qualquer pre√ßo acima do CVU (R\\$ 20) gera **MC adicional**. R\\$ 25 > R\$ 20 ‚Üí **aceitar**."
            },
            {
                "question": "Qual √© a principal desvantagem do custeio por absor√ß√£o na an√°lise de lucratividade por produto?",
                "options": [
                    "√â mais complexo de calcular",
                    "Subestima os custos vari√°veis",
                    "Pode alocar custos fixos de forma arbitr√°ria, distorcendo a rentabilidade",
                    "N√£o considera despesas administrativas",
                    "Exige software especializado"
                ],
                "correct": 2,
                "explanation": "A aloca√ß√£o de custos fixos pode fazer produtos com baixa demanda parecerem menos lucrativos do que realmente s√£o."
            },
            {
                "question": "A MC unit√°ria √© R\\$ 15. O CF total √© R\\$ 60.000. Qual √© o PE em unidades?",
                "options": [
                    "3.000",
                    "4.000",
                    "5.000",
                    "6.000",
                    "7.000"
                ],
                "correct": 1,  # 60.000 / 15 = 4.000
                "explanation": "PE = CF / MC unit√°ria = 60.000 / 15 = **4.000 unidades**."
            },
            {
                "question": "Se o PE √© 1.200 unidades e as vendas s√£o 1.500, qual √© a margem de seguran√ßa?",
                "options": [
                    "10%",
                    "15%",
                    "20%",
                    "25%",
                    "30%"
                ],
                "correct": 3,  # (1500-1200)/1500 = 300/1500 = 20%
                "explanation": "(1.500 - 1.200) / 1.500 = 300 / 1.500 = **20%**."
            },
            {
                "question": "O que acontece com a MC se o custo vari√°vel unit√°rio aumentar?",
                "options": [
                    "Aumenta",
                    "Permanece constante",
                    "Diminui",
                    "Torna-se negativa",
                    "Depende do pre√ßo"
                ],
                "correct": 2,
                "explanation": "MC = PV - CVU. Se CVU aumenta, MC **diminui**, reduzindo a capacidade de cobrir custos fixos."
            },
            {
                "question": "Por que a an√°lise CVL √© importante para o gestor?",
                "options": [
                    "Para calcular o imposto de renda",
                    "Para determinar o estoque de seguran√ßa",
                    "Para entender o impacto de mudan√ßas no volume sobre o lucro",
                    "Para avaliar o desempenho do RH",
                    "Para prever a infla√ß√£o"
                ],
                "correct": 2,
                "explanation": "A an√°lise CVL mostra como varia√ß√µes no volume de vendas afetam custos e lucros, essencial para planejamento."
            }
        ]
    
        if 'quiz_answers_part2' not in st.session_state:
            st.session_state.quiz_answers_part2 = [None] * len(questions)
    
        user_score = 0
        for i, q in enumerate(questions):
            st.markdown(f"**{i+1}. {q['question']}**")
            user_answer = st.radio(
                q["question"],
                options=q["options"],
                key=f"quiz2_q{i}",
                index=st.session_state.quiz_answers_part2[i] if st.session_state.quiz_answers_part2[i] is not None else None
            )
            st.session_state.quiz_answers_part2[i] = q["options"].index(user_answer) if user_answer else None
    
            if user_answer:
                if q["options"].index(user_answer) == q["correct"]:
                    st.success("‚úÖ Correto!")
                    user_score += 1
                else:
                    st.error(f"‚ùå Incorreto. A resposta correta √©: **{q['options'][q['correct']]}**.")
                    with st.expander("üìò Explica√ß√£o"):
                        st.markdown(q["explanation"])
    
        if all(ans is not None for ans in st.session_state.quiz_answers_part2):
            st.markdown("---")
            st.markdown(f"### üéØ Pontua√ß√£o: **{user_score}/{len(questions)}**")
            if user_score >= 9:
                st.balloons()
                st.success("üéâ Parab√©ns! Excelente dom√≠nio da an√°lise gerencial!")
            elif user_score >= 6:
                st.success("üëç Bom trabalho!")
            else:
                st.warning("üìö Revise os conceitos com os materiais anteriores.")
                
    # ===========================
    # Final: Pr√≥xima Etapa
    # ===========================
    st.divider()
    st.markdown("‚úÖ Parab√©ns! Voc√™ completou a an√°lise interativa de Custeio Vari√°vel.")

    if st.button("üëâ Avan√ßar para o pr√≥ximo t√≥pico: Precifica√ß√£o a partir do custo"):
        st.switch_page("pages/5_üí∞_Precificacao.py")

if __name__ == "__main__":
    main()
